name: Fuzz Testing

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 3'  # Weekly on Wednesday

permissions:
  contents: read

jobs:
  fuzz:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608  # v4

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,visualization]"
          pip install hypothesis atheris psutil

      - name: Run Hypothesis fuzz tests
        run: |
          pytest tests/ -v -k "property or fuzz" --hypothesis-seed=0 \
            --hypothesis-profile=ci -x
        env:
          HYPOTHESIS_PROFILE: ci

      - name: Run atheris fuzzer on core functions
        run: |
          python << 'EOF'
          import atheris
          import sys

          with atheris.instrument_imports():
              import boofun as bf
              import numpy as np

          def test_create_from_bytes(data):
              """Fuzz test bf.create with random bytes."""
              fdp = atheris.FuzzedDataProvider(data)
              n = fdp.ConsumeIntInRange(1, 8)
              size = 2 ** n
              values = [fdp.ConsumeBool() for _ in range(size)]
              try:
                  f = bf.create(values)
                  # Should not crash
                  f.evaluate(0)
                  f.fourier()
              except (ValueError, TypeError):
                  pass  # Expected for invalid inputs

          def test_evaluate_from_bytes(data):
              """Fuzz test evaluate with random inputs."""
              fdp = atheris.FuzzedDataProvider(data)
              n = fdp.ConsumeIntInRange(2, 6)
              f = bf.majority(n)
              idx = fdp.ConsumeIntInRange(0, 2**n - 1)
              try:
                  f.evaluate(idx)
              except (ValueError, IndexError):
                  pass

          # Run for limited time in CI
          atheris.Setup(sys.argv, test_create_from_bytes)
          atheris.Fuzz()
          EOF
        timeout-minutes: 5
        continue-on-error: true  # Fuzzing may find issues, don't fail CI
