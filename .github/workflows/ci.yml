name: CI

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v4

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v5
      with:
        python-version: '3.11'

    - name: Install pre-commit
      run: pip install pre-commit

    - name: Run pre-commit hooks
      run: pre-commit run --all-files

  # Detect what files changed to skip unnecessary jobs
  changes:
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      docs: ${{ steps.filter.outputs.docs }}
      notebooks: ${{ steps.filter.outputs.notebooks }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v4
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36  # v3
        id: filter
        with:
          filters: |
            code:
              - 'src/**'
              - 'tests/**'
              - 'pyproject.toml'
              - 'setup.cfg'
              - 'setup.py'
              - '.pre-commit-config.yaml'
              - '.github/workflows/**'
            docs:
              - 'docs/**'
              - '*.md'
            notebooks:
              - 'notebooks/**'

  typecheck:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true' || github.event_name == 'workflow_dispatch'
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v4

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run type checking (mypy)
      run: mypy src/boofun --ignore-missing-imports

  test:
    runs-on: ${{ matrix.os }}
    needs: [lint, changes]
    if: needs.changes.outputs.code == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
        exclude:
          # Reduce matrix for faster CI
          - os: macos-latest
            python-version: '3.9'
          - os: windows-latest
            python-version: '3.9'

    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,visualization]"
        pip install psutil

    - name: Run tests
      run: pytest tests/ -v --tb=short

    - name: Run tests with coverage
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      run: |
        pip install pytest-cov
        pytest tests/ --cov=boofun --cov-report=xml --cov-report=term-missing

    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de  # v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage.xml
        fail_ci_if_error: false
        verbose: true

  notebooks:
    runs-on: ubuntu-latest
    needs: [lint, changes]
    if: needs.changes.outputs.notebooks == 'true' || github.event_name == 'workflow_dispatch'
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v4

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,visualization]"
        pip install jupyter nbconvert

    - name: Validate notebooks
      run: |
        # Run key notebooks to ensure they execute without errors
        for notebook in \
          notebooks/lecture1_fourier_expansion.ipynb \
          notebooks/lecture2_linearity_testing.ipynb \
          notebooks/hw1_fourier_expansion.ipynb \
          notebooks/real_world_applications.ipynb
        do
          echo "Testing: $notebook"
          jupyter nbconvert --to notebook --execute "$notebook" \
            --ExecutePreprocessor.timeout=120 \
            --output /tmp/test_output.ipynb
        done

  mutation:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        pip install mutmut

    - name: Run mutation testing (core modules)
      run: |
        # Run mutation testing on critical modules only (full run too slow)
        mutmut run --paths-to-mutate=src/boofun/core/optimizations.py \
          --tests-dir=tests/core/ \
          --runner="pytest -x -q" \
          --no-progress || true
        mutmut results

  benchmark:
    runs-on: ubuntu-latest
    needs: test
    # Only run on releases or manual trigger (not PRs - too slow)
    if: (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) || github.event_name == 'workflow_dispatch'
    timeout-minutes: 15
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v4

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,performance]"
        pip install pytest-benchmark

    - name: Run benchmarks
      run: |
        python << 'EOF'
        import boofun as bf
        import time
        from boofun.analysis import SpectralAnalyzer
        from boofun.analysis.query_complexity import QueryComplexityProfile

        print('=== Boolean Function Library Benchmarks ===')
        print()

        for n in [6, 8, 10]:  # Skip n=12 (too slow for CI)
            print(f'n={n}:')

            start = time.time()
            maj = bf.majority(n)
            print(f'  Create Majority: {(time.time() - start)*1000:.2f}ms')

            start = time.time()
            analyzer = SpectralAnalyzer(maj)
            fourier = analyzer.fourier_expansion()
            print(f'  Fourier expansion: {(time.time() - start)*1000:.2f}ms')

            start = time.time()
            influences = analyzer.influences()
            print(f'  Compute influences: {(time.time() - start)*1000:.2f}ms')

            start = time.time()
            profile = QueryComplexityProfile(maj)
            profile.compute()
            print(f'  Full BFW profile: {(time.time() - start)*1000:.2f}ms')

            print()
        EOF

  docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v4

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,docs]"

    - name: Build documentation
      run: |
        cd docs
        make html

    - name: Convert notebooks to HTML
      run: |
        mkdir -p docs/_build/html/notebooks
        pip install nbconvert
        # Convert all notebooks (lecture, homework, and supplementary)
        for nb in notebooks/*.ipynb; do
          jupyter nbconvert --to html "$nb" --output-dir docs/_build/html/notebooks/
        done

    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@373f7f263a76c20808c831209c920827a82a2847  # v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/_build/html
        force_orphan: true

  publish:
    needs: [test, docs]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v4

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v5
      with:
        python-version: '3.11'

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine sigstore

    - name: Build package
      run: python -m build

    - name: Sign artifacts with Sigstore
      uses: sigstore/gh-action-sigstore-python@f514d46b907ebcd5bedc05145c03b69c1edd8b46  # v3.0.0
      with:
        inputs: ./dist/*

    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
      run: |
        if [ -z "$TWINE_PASSWORD" ]; then
          echo "::warning::PYPI_TOKEN secret not configured, skipping publish"
          exit 0
        fi
        twine upload dist/*.whl dist/*.tar.gz
